// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenant: Each salon is a tenant
model Tenant {
  id          String   @id @default(cuid())
  businessName String
  logo        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Subscription
  subscriptionStatus String @default("trial") // trial, active, expired, cancelled
  subscriptionPlan   String? // basic, premium, enterprise
  trialEndsAt        DateTime?
  subscriptionEndsAt DateTime?
  
  // Relations
  branches    Branch[]
  users       User[]
  services    Service[]
  clients     Client[]
  appointments Appointment[]
  inventory   InventoryItem[]
  invoices    Invoice[]
  feedbacks   Feedback[]
  
  @@map("tenants")
}

// Branch management
model Branch {
  id          String   @id @default(cuid())
  name        String
  address     String?
  phone       String?
  email       String?
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  staff       Staff[]
  appointments Appointment[]
  
  @@map("branches")
}

// User roles: owner, admin, receptionist, staff
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String
  name        String
  phone       String
  role        String   // owner, admin, receptionist, staff
  tenantId    String
  branchId    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch      Branch?  @relation(fields: [branchId], references: [id])
  staff       Staff?
  
  @@map("users")
}

// Staff details (linked to User)
model Staff {
  id          String   @id @default(cuid())
  userId      String   @unique
  branchId    String
  role        String   // stylist, barber, therapist, etc.
  shiftStart  String?  // HH:mm format
  shiftEnd    String?  // HH:mm format
  salary      Float?
  joiningDate DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  services    ServiceStaff[]
  performance StaffPerformance?
  
  @@map("staff")
}

// Staff performance metrics
model StaffPerformance {
  id              String   @id @default(cuid())
  staffId         String   @unique
  servicesCompleted Int    @default(0)
  revenueGenerated  Float  @default(0)
  averageRating     Float  @default(0)
  totalRatings      Int    @default(0)
  attendanceRate    Float  @default(0)
  lastUpdated     DateTime @default(now()) @updatedAt
  
  staff           Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  
  @@map("staff_performance")
}

// Client CRM
model Client {
  id            String   @id @default(cuid())
  tenantId      String
  name          String
  phone         String
  email         String?
  dateOfBirth   DateTime?
  address       String?
  loyaltyTier   String   @default("Silver") // Silver, Gold, Platinum
  totalVisits   Int      @default(0)
  totalSpend    Float    @default(0)
  preferredStaffId String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments  Appointment[]
  invoices      Invoice[]
  feedbacks     Feedback[]
  
  @@unique([tenantId, phone])
  @@map("clients")
}

// Service catalog
model Service {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  duration    Int      // minutes
  price       Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  serviceItems ServiceItem[]
  serviceStaff ServiceStaff[]
  
  @@map("services")
}

// Service-Inventory linking
model ServiceItem {
  id          String   @id @default(cuid())
  serviceId   String
  inventoryItemId String
  quantity    Float    // amount consumed per service
  unit        String   // ml, g, piece, etc.
  
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  
  @@map("service_items")
}

// Service-Staff linking (which staff can perform which service)
model ServiceStaff {
  id          String   @id @default(cuid())
  serviceId   String
  staffId    String
  
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  staff       Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  
  @@unique([serviceId, staffId])
  @@map("service_staff")
}

// Inventory management
model InventoryItem {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  unit        String   // ml, g, piece, etc.
  quantity    Float
  threshold   Float    // alert when below this
  supplier    String?
  costPrice   Float?
  sellingPrice Float?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  serviceItems ServiceItem[]
  
  @@map("inventory_items")
}

// Appointments
model Appointment {
  id          String   @id @default(cuid())
  tenantId    String
  branchId    String
  clientId    String
  serviceId   String
  staffId     String
  status      String   @default("booked") // booked, ongoing, completed, cancelled, no-show
  scheduledAt DateTime
  completedAt DateTime?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service     Service  @relation(fields: [serviceId], references: [id])
  staff       Staff    @relation(fields: [staffId], references: [id])
  invoice     Invoice?
  
  @@map("appointments")
}

// Invoices/Billing
model Invoice {
  id          String   @id @default(cuid())
  tenantId    String
  appointmentId String @unique
  clientId    String
  invoiceNumber String @unique
  subtotal    Float
  tax         Float    @default(0)
  discount    Float    @default(0)
  total       Float
  paymentMethod String? // cash, upi, card, credit
  paymentStatus String @default("pending") // pending, paid, partial, refunded
  paidAt      DateTime?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoiceItems InvoiceItem[]
  
  @@map("invoices")
}

// Invoice line items
model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  itemType    String   // service, product
  itemName    String
  quantity    Float    @default(1)
  price       Float
  total       Float
  
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("invoice_items")
}

// Feedback & Ratings
model Feedback {
  id          String   @id @default(cuid())
  tenantId    String
  clientId    String
  appointmentId String?
  staffId     String?
  rating      Int      // 1-5
  comment     String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@map("feedbacks")
}

// Audit logs
model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String?
  userId      String?
  action      String   // create, update, delete
  entity      String   // appointment, client, service, etc.
  entityId    String
  changes     String?  // JSON string of changes
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  @@map("audit_logs")
}

// Working hours configuration
model WorkingHours {
  id          String   @id @default(cuid())
  tenantId    String
  branchId    String?
  dayOfWeek   Int      // 0-6 (Sunday-Saturday)
  isOpen      Boolean  @default(true)
  openTime    String?  // HH:mm
  closeTime   String?  // HH:mm
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, branchId, dayOfWeek])
  @@map("working_hours")
}

